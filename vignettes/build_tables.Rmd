---
title: "build_tables"
output: 
  rmarkdown::html_vignette:
    keep_md: true
    toc: true
vignette: >
  %\VignetteIndexEntry{build_tables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(vigicaen)
```

# Purpose

Have you subscribed to VigiBase Extract Case Level, WHODrug and MedDRA?

Congratulations! You've made it half way to explore VigiBase.

Now, you need to process those large text/ascii files into R readable
files. This is the purpose of the `tb_*` functions (Table Builders).

## Overview

| tb\_\* function | Usage                                                                    |
|--------------------|----------------------------------------------------|
| tb_vigibase     | Main tables (demo, drugs, adverse drug reactions), and subsidiary tables |
| tb_who          | WHODrug tables                                                           |
| tb_meddra       | MedDRA tables                                                            |

## Basic usage

First, UNZIP the files you received from UMC (beware that you also need
to unzip sub-folders, inside the main zip file).

That will give you a folder structure like this:

-   /vigibase_ecl
-   .../main
-   .../who
-   .../sub

Although the names can be longer, we strongly suggest you shortened them
to main, who, sub.

You just need to provide a path to these files on your computer.

```{r basic, eval = FALSE}

tb_vigibase(path_main, path_sub)
tb_who(path_who)
tb_meddra(path_meddra)

```

And this is a step you only have to perform ONCE per database version.

New parquet files will be created in the same directories as provided
with `path_*`.

> The suspectedduplicates table is delivered with subsidiary files, but
> the `tb_vigibase()` function will output it in the main directory,
> under a slightly modified name.

## Outputs

The `tb_*` functions create
[parquet](https://arrow.apache.org/docs/r/index.html) files. Parquet is
an open-source format, supported by Arrow.

Not all tables from each source are created during the process.

-   Main: All tables + subsidiary tables (from sub):
demo, drug, adr, link, ind, srce, out, followup, suspdup,
AgeGroup, Dechallenge, Dechallenge2, Frequency,
Gender, Notifier, Outcome, Rechallenge, Rechallenge2, Region,
RepBasis, ReportType, RouteOfAdm, Seriousness, and SizeUnit.

-   WHODrug: All tables - mp + mp_short: thg, pp, 
ing, srce, org, ccode, atc, sun, pf, str, prg, prt, unitx. Again,
check correspondence in the delivered files from UMC.

-   Meddra: meddra_hierarchy, smq_list, and smq_content.

`mp_short` is a short version of mp table, which has been tolower-ed and
trim-ed on drug name, to be more handy. A few columns have also been
removed.

# Loading tables into R

You can use the arrow package built-in readers to load the tables, or
the `dt_parquet()` function from this package, which is a shorthand.

```{r load_tables, eval = FALSE}

demo <- dt_parquet(path_main, "demo")
drug <- dt_parquet(path_main, "drug")
adr  <- dt_parquet(path_main, "adr")
link <- dt_parquet(path_main, "link")
# etc.

mp_short <- dt_parquet(path_who, "mp_short")

meddra <- dt_parquet(path_meddra, "meddra_hierarchy")

```

> Parquet files will be loaded IN memory, by default. To change this
> behavior, remember to set `in_memory = FALSE`. Be careful that the
> output format will be different.

You can `dplyr::left_join()` smq_content to smq_list if you work only
with NON-algorithmic SMQs.

```{r joining_smq_tables, eval = FALSE}
smq_list    <- dt_parquet(path_meddra, "smq_list.parquet")
smq_content <- dt_parquet(path_meddra, "smq_content.parquet")

smq_list_content <-
  smq_list |>
  # Only works for NON-algorithmic SMQs
  dplyr::left_join(smq_content, by = "smq_code") |>
  data.table::data.table()
```

# Subsetting tables

If you want to work on a specific subset of VigiBase (e.g. older adults,
some specific drugs, or adverse drug reaction), you can create a
dedicated subset with the `tb_subset()` function.

Currently, you can subset on

-   Age groups

-   Drug record numbers (DrecNo) and Medicinal product IDs
    (MedicinalProd_Id)

-   MedDRA codes of adverse drug reactions (MedDRA_Id)

Type `?vigicaen::tb_subset` for more help

```{r tb_subset, eval = FALSE}

sv_selection <-
    c(7, 8)

wd_in <- "some/place/on/your/computer/containing/vigibase_ecl/data"

wd_out <- paste0(wd_in, "/", "more_than_65_subset", "/")

tb_subset(wd_in, wd_out,
          subset_var = "age",
          sv_selection = sv_selection)
```
